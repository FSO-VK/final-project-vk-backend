name: CI — lint, build-check, test, publish-on-dev

on:
  push:
    branches:
      - master
      - dev
  pull_request:
    branches:
      - master
      - dev
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch to run against (example: feature/x or dev or master)"
        required: false
        default: ""

env:
  GO_VERSION: '1.25.x'
  # ХАРДКОДИМ owner/name в нижнем регистре — по Docker-правилам.
  IMAGE_REPO: ghcr.io/fso-vk/fso-auth

permissions:
  contents: read
  packages: write

jobs:
  lint:
    name: Lint (make lint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25.x'

      - name: Ensure make exists (install only if missing)
        run: |
          if ! command -v make >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y make
          fi

      - name: Install golangci-lint v2.4.0 into ./.bin
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          BIN_DIR="${GITHUB_WORKSPACE}/.bin"
          mkdir -p "${BIN_DIR}"
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/HEAD/install.sh \
            | sh -s -- -b "${BIN_DIR}" v2.4.0
          echo "${BIN_DIR}" >> $GITHUB_PATH
          "${BIN_DIR}/golangci-lint" --version

      - name: Run lint via Makefile
        run: make lint

  set-vars:
    name: Set branch variables
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      branch: ${{ steps.branch.outputs.branch }}
    steps:
      - name: Determine branch name
        id: branch
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "branch=${{ github.head_ref }}" >> "$GITHUB_OUTPUT"
          elif [ -n "${{ github.event.inputs.ref }}" ]; then
            echo "branch=${{ github.event.inputs.ref }}" >> "$GITHUB_OUTPUT"
          else
            REF="${GITHUB_REF#refs/heads/}"
            echo "branch=${REF}" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: Build (check that image builds) — no push here
    runs-on: ubuntu-latest
    needs: [lint, set-vars]
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx (keeps option for multi-arch)
        uses: docker/setup-buildx-action@v3

      - name: Prepare image variables (simple, hardcoded repo; clean branch -> lowercase & replace / -> -)
        id: prepare
        run: |
          RAW_BRANCH="${{ needs.set-vars.outputs.branch }}"
          # fallback if empty (rare)
          if [ -z "$RAW_BRANCH" ]; then
            RAW_BRANCH="${{ github.ref_name || 'unknown' }}"
          fi
          BRANCH="$(printf '%s' "$RAW_BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's|/|-|g')"
          echo "BRANCH=${BRANCH}" >> $GITHUB_ENV
          echo "IMAGE_REPO=${{ env.IMAGE_REPO }}" >> $GITHUB_ENV
          echo "Prepared IMAGE_REPO=${{ env.IMAGE_REPO }} BRANCH=${BRANCH}"

      - name: Build image (local test, no push)
        env:
          IMAGE_REPO: ${{ env.IMAGE_REPO }}
          BRANCH: ${{ env.BRANCH }}
        run: |
          # final tag
          TAG="${IMAGE_REPO}:${BRANCH}"
          echo "Building image ${TAG} (no push)"
          docker build -f ./build/services/app/Dockerfile -t "${TAG}" .

  test:
    name: Tests & coverage
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install system deps (if needed)
        run: sudo apt-get update -y

      - name: Run tests with coverage
        run: |
          go test -v ./... -coverprofile=coverage.out

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.out

  publish:
    name: Publish image (conditional)
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare image variables for publish
        run: |
          RAW_BRANCH="${{ needs.set-vars.outputs.branch }}"
          if [ -z "$RAW_BRANCH" ]; then
            RAW_BRANCH="${{ github.ref_name || 'dev' }}"
          fi
          BRANCH="$(printf '%s' "$RAW_BRANCH" | tr '[:upper:]' '[:lower:]' | sed 's|/|-|g')"
          IMAGE_REPO="${{ env.IMAGE_REPO }}"
          echo "BRANCH=${BRANCH}" >> $GITHUB_ENV
          echo "IMAGE_REPO=${IMAGE_REPO}" >> $GITHUB_ENV
          echo "Publishing ${IMAGE_REPO}:${BRANCH}"

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT || secrets.GITHUB_TOKEN }}

      - name: Build and push image (tagged with branch)
        env:
          IMAGE_REPO: ${{ env.IMAGE_REPO }}
          BRANCH: ${{ env.BRANCH }}
        run: |
          TAG="${IMAGE_REPO}:${BRANCH}"
          echo "Buildx build+push -> ${TAG}"
          docker buildx build --push --platform linux/amd64,linux/arm64 \
            --tag "${TAG}" \
            -f ./build/services/app/Dockerfile .
