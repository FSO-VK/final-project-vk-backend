name: CI — lint, build-check, test, publish-on-dev

# Триггеры:
# - push в master/dev -> автоматический запуск
# - pull_request targeting master/dev -> автоматический запуск (no publish)
# - workflow_dispatch -> ручной запуск (можно указать branch но будет без публикации)
on:
  push:
    branches:
      - master
      - dev
  pull_request:
    branches:
      - master
      - dev
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch to run against (example: feature/x or dev or master)"
        required: false
        default: ""

env:
  GO_VERSION: '1.25.x'
  IMAGE_REPO: ghcr.io/${{ github.repository_owner }}/fso-auth

permissions:
  contents: read
  packages: write   # нужно для пуша в GHCR

jobs:
  lint:
    name: Lint (make lint)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25.x'

      - name: Ensure make exists (install only if missing)
        run: |
          if ! command -v make >/dev/null 2>&1; then
            echo "make not found — installing"
            sudo apt-get update -y
            sudo apt-get install -y make
          else
            echo "make found: $(which make)"
          fi

      - name: Install golangci-lint v2.4.0 (official CI installer)
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          BIN_DIR="${GITHUB_WORKSPACE}/.bin"
          mkdir -p "${BIN_DIR}"
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/HEAD/install.sh \
            | sh -s -- -b "${BIN_DIR}" v2.4.0
          # expose bin dir to following steps
          echo "${BIN_DIR}" >> $GITHUB_PATH
          # quick check
          "${BIN_DIR}/golangci-lint" --version

      - name: Run lint via Makefile
        run: make lint

  set-vars:
    name: Set branch variables
    runs-on: ubuntu-latest
    needs: lint
    outputs:
      branch: ${{ steps.branch.outputs.branch }}
    steps:
      - name: Determine branch name
        id: branch
        run: |
          # Для разных событий branch может быть в другом поле
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "branch=${{ github.head_ref }}" >> "$GITHUB_OUTPUT"
          elif [ -n "${{ github.event.inputs.ref }}" ]; then
            # manual override via workflow_dispatch
            echo "branch=${{ github.event.inputs.ref }}" >> "$GITHUB_OUTPUT"
          else
            # push events: strip refs/heads/
            REF="${GITHUB_REF#refs/heads/}"
            echo "branch=${REF}" >> "$GITHUB_OUTPUT"
          fi

  build:
    name: Build (check that image builds) — no push here
    runs-on: ubuntu-latest
    needs: [lint, set-vars]
    steps:
      - name: Checkout (full)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image (local test, no push)
        id: build
        run: |
          BRANCH=${{ needs.set-vars.outputs.branch }}
          IMAGE_TAG="${{ env.IMAGE_REPO }}:${BRANCH}"
          echo "Building image ${IMAGE_TAG} (no push)"
          docker build -f ./build/services/app/Dockerfile -t "${IMAGE_TAG}" .

  test:
    name: Tests & coverage
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout (full)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install system deps (if needed)
        run: |
          sudo apt-get update

      - name: Run tests with coverage
        run: |
          go test -v ./... -coverprofile=coverage.out

      - name: Upload coverage artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage.out

  publish:
    name: Publish image (conditional)
    runs-on: ubuntu-latest
    needs: test
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/dev')
    steps:
      - name: Checkout (full)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          # Prefer GHCR_PAT secret if present, otherwise GITHUB_TOKEN may be used
          password: ${{ secrets.GHCR_PAT || secrets.GITHUB_TOKEN }}

      - name: Build and push image (tagged with branch)
        env:
          BRANCH: ${{ needs.set-vars.outputs.branch }}
          IMAGE_REPO: ${{ env.IMAGE_REPO }}
        run: |
          IMAGE_TAG="${IMAGE_REPO}:${BRANCH}"
          echo "Buildx build+push -> ${IMAGE_TAG}"
          docker buildx build --push --platform linux/amd64,linux/arm64 \
            --tag "${IMAGE_TAG}" \
            -f ./build/services/app/Dockerfile .
