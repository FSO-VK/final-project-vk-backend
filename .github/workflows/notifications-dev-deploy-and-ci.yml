name: CI — lint, build-check, test, publish-on-dev

on:
  push:
    branches: [ master, dev ]
    paths:
      - 'internal/notifications/**'
      - 'cmd/notifications/**'
      - 'build/services/notifications.Dockerfile'
      - 'config/notifications-conf.yaml'
  pull_request:
    branches: [ master, dev ]
    paths:
      - 'internal/notifications/**'
      - 'cmd/notifications/**'
      - 'build/services/notifications.Dockerfile'
      - 'config/notifications-conf.yaml'
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch to run against (example: dev or master)"
        required: false
        default: ""

env:
  GO_VERSION: '1.25.x'
  IMAGE_REPO: ghcr.io/fso-vk/fso-notifications

permissions:
  contents: read
  packages: write

jobs:
  lint:
    name: Lint (make lint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.25.x'

      - name: Ensure make exists
        run: |
          if ! command -v make >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y make
          fi

      - name: Install golangci-lint v2.4.0
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}
        run: |
          BIN_DIR="${GITHUB_WORKSPACE}/.bin"
          mkdir -p "${BIN_DIR}"
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/HEAD/install.sh \
            | sh -s -- -b "${BIN_DIR}" v2.4.0
          echo "${BIN_DIR}" >> $GITHUB_PATH
          "${BIN_DIR}/golangci-lint" --version

      - name: Run lint via Makefile
        run: make lint

  build:
    name: Build (check image builds)
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build image
        run: |
          # Определяем тег один раз для всех случаев
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TARGET="handmade"
          elif [ "${{ github.ref }}" = "refs/heads/master" ]; then
            TARGET="master"
          elif [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            TARGET="dev"
          else
            TARGET="pr-test"
          fi
          
          TAG="${{ env.IMAGE_REPO }}:${TARGET}"
          echo "Building image ${TAG} using build/services/notifications.Dockerfile"
          docker buildx build --load \
            --tag "${TAG}" \
            -f ./build/services/notifications.Dockerfile .

  test:
    name: Run tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install gotestsum
        run: go install gotest.tools/gotestsum@latest

      - name: Run tests via Makefile
        run: make test

  publish:
    name: Publish image (conditional)
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/dev'
    steps:
      - uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT || secrets.GITHUB_TOKEN }}

      - name: Build and push image
        run: |
          # В publish всегда используем тег dev
          TAG="${{ env.IMAGE_REPO }}:dev"
          echo "Buildx build+push -> ${TAG}"
          docker buildx build --push --platform linux/amd64,linux/arm64 \
            --tag "${TAG}" \
            -f ./build/services/notifications.Dockerfile .