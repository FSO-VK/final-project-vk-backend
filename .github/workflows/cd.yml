name: CD — deploy to remote server (pull images & apply)

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Determine deploy target
        id: target
        run: |
          set -eu
          EVENT_NAME="${{ github.event_name }}"
          REF="${{ github.ref }}"
          TARGET=""
          if [ "${EVENT_NAME}" = "push" ]; then
            # push event -> determine by branch
            case "${REF}" in
              refs/heads/main)
                TARGET="prod"
                ;;
              refs/heads/dev)
                TARGET="dev"
                ;;
              *)
                echo "Ref ${REF} is not main/dev; defaulting to dev"
                TARGET="dev"
                ;;
            esac
          else
            # For any other events (shouldn't happen with current config), default to dev
            TARGET="dev"
          fi
          echo "target=${TARGET}" >> "$GITHUB_OUTPUT"

      - name: Deploy via SSH (safe recreate directory, pull & up)
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER_NAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}
          script: |
            set -euo pipefail
            TARGET="${{ steps.target.outputs.target }}"
            echo "Deploy target: ${TARGET}"

            HOME_DIR="${HOME}"
            if [ "${TARGET}" = "prod" ]; then
              DEPLOY_DIR="${HOME_DIR}/CD_prod"
            else
              DEPLOY_DIR="${HOME_DIR}/CD_dev"
            fi

            # Safety check: ensure DEPLOY_DIR is exactly one of allowed locations
            case "${DEPLOY_DIR}" in
              "${HOME_DIR}/CD_prod" | "${HOME_DIR}/CD_dev")
                echo "Deploy directory is safe: ${DEPLOY_DIR}"
                ;;
              *)
                echo "ERROR: Unsafe deploy directory: ${DEPLOY_DIR}"
                exit 1
                ;;
            esac

            # Optional: repository URL (put into repo secret if you want automatic clone)
            REPO_URL="${{ secrets.REPO_URL || '' }}"

            # If directory exists, remove it (user requested remove/create).
            # Do a quick safety backup (move) first, then remove the backup to ensure clean state.
            # maybe backup rotation in the future
            if [ -d "${DEPLOY_DIR}" ]; then
              BACKUP="${DEPLOY_DIR}_backup_$(date +%s)"
              echo "Moving existing ${DEPLOY_DIR} -> ${BACKUP}"
              mv "${DEPLOY_DIR}" "${BACKUP}"
              echo "Removing backup ${BACKUP}"
              rm -rf "${BACKUP}"
            fi

            # Create fresh directory
            mkdir -p "${DEPLOY_DIR}"
            cd "${DEPLOY_DIR}"

            # If REPO_URL provided, clone repository here (depth 1)
            if [ -n "${REPO_URL}" ]; then
              echo "Cloning repo ${REPO_URL} into ${DEPLOY_DIR}"
              git clone --depth 1 "${REPO_URL}" .
            else
              echo "No REPO_URL provided via secrets.REPO_URL — assuming compose file already present on server at ${DEPLOY_DIR}"
            fi

            COMPOSE_FILE="${DEPLOY_DIR}/all-services-compose.yaml"
            if [ ! -f "${COMPOSE_FILE}" ]; then
              echo "ERROR: compose file not found at ${COMPOSE_FILE}"
              exit 1
            fi

            # Pull images and start
            echo "Pulling images from registry (ignoring failures)..."
            docker compose -f "${COMPOSE_FILE}" pull --ignore-pull-failures

            echo "Bringing up services..."
            docker compose -f "${COMPOSE_FILE}" up -d --remove-orphans

            # Run migrations for prod (now it do nothing :) )
            if [ "${TARGET}" = "prod" ] && [ -x /home/deploy/go/bin/tern ]; then
              echo "Running migrations (prod)..."
              /home/deploy/go/bin/tern migrate || true
            else
              echo "Skipping migrations for target ${TARGET}"
            fi

            echo "Deploy finished for ${TARGET} (dir: ${DEPLOY_DIR})"
